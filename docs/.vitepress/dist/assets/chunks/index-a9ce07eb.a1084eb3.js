import{e as A,j,f as z,o as V,c as O,d as T,q as W,b as y,s as te,r as E,w as K,k as be,D as le,E as oe,u as a,P as ke,n as ae,M as ge,U as Ce,p as Ne,V as Se,v as Q,Z as ue,W as _e,F as fe,N as $e,g as Ie,A as ee,m as Re,a5 as ce}from"../app.9ec52d9f.js";import{s as se,F as q,v as ne,w as de,a as Ee,B as Ve,D as Te,j as Be,q as De,L as ve,o as Me,M as pe,z as X,l as Ue}from"./index-3519e374.9c71cf1c.js";import{p as he}from"./icon.vue_vue_type_script_setup_true_lang-cc078b52.40cc991d.js";import{R as Fe}from"./vuedraggable.umd-6a5b6da9.78f40607.js";import"./commonjsHelpers-c5d32002.490f5bf3.js";const je={class:"action-item whitespace-nowrap"},ze=A({__name:"previewWidgets",setup(M){const d=j("pageManager",{}),v=j("pageSchema"),e=j("designer"),i=E(null),r=E(null),n=E(null),w=E(!1),C=E(!1),b=E(!0),p=E("top"),{canvasScale:k,disabledZoom:B}=se();let t=null;const o=z(()=>{var $;var l,u,s,_,g;const f=d.componentInstances.value,x=(l=e.state.checkedNode)==null?void 0:l.id,c=($=q.getComponentConfingByType((u=e.state.checkedNode)==null?void 0:u.type))!=null?$:null;if(!x||!(f!=null&&f[x]))return null;if(c!=null&&c.defaultSchema.input&&((s=e.state.checkedNode)==null?void 0:s.noFormItem)!==!0)return(_=f[x+"formItem"])==null?void 0:_.$el;const N=f[x];return((g=N==null?void 0:N.$el)==null?void 0:g.nodeName)==="#text"?null:N==null?void 0:N.$el}),h=z(()=>{var N;var l,u,s,_;const g=d.componentInstances.value,f=(l=e.state.hoverNode)==null?void 0:l.id,x=(N=q.getComponentConfingByType((u=e.state.hoverNode)==null?void 0:u.type))!=null?N:null;if(!f||!(g!=null&&g[f]))return null;if(x!=null&&x.defaultSchema.input&&((s=e.state.hoverNode)==null?void 0:s.noFormItem)!==!0)return(_=g[f+"formItem"])==null?void 0:_.$el;const c=g[f];return(c==null?void 0:c.$el.nodeName)==="#text"?null:c==null?void 0:c.$el}),{mutationObserver:R,observerConfig:D}=P(F),{startTimedQuery:U,stopTimedQuery:Y}=De(F);K(()=>o.value,l=>{if(l){w.value=!0,R.observe(l,D);const u=l.parentNode;u&&(u.ondragstart=()=>{b.value=!1,U()},u.ondragend=()=>{b.value=!0,Y()}),F()}else w.value=!1});const{mutationObserver:S,observerConfig:m}=P(L);K(()=>h.value,l=>{l&&(S.observe(l,m),L())});let I=0;K(()=>{var l;return(l=e.state.hoverNode)==null?void 0:l.id},l=>{C.value=!0,clearTimeout(I),!l&&(I=setTimeout(()=>{C.value=!1},300))});function F(){var G,Z,J;const l=o.value;if(!l)return;const{top:u,left:s}=(G=t==null?void 0:t.getBoundingClientRect())!=null?G:{top:0,left:0},{top:_,left:g,width:f,height:x}=l.getBoundingClientRect(),c=B.value?1:k.value,N=_-u+((Z=t==null?void 0:t.scrollTop)!=null?Z:0)*c,$=g-s+((J=t==null?void 0:t.scrollLeft)!=null?J:0)*c,H=x/c;i.value&&(i.value.style.width=`${f/c}px`,i.value.style.height=`${H}px`,i.value.style.top=`${N/c}px`,i.value.style.left=`${$/c}px`),n.value&&(N<45&&H<100?(n.value.style.top="",n.value.style.bottom="-30px",n.value.style["border-radius"]="0px 0px 4px 4px",p.value="bottom"):N<45?(n.value.style.top="0px",n.value.style["border-radius"]="0px 0px 4px 0",p.value="center"):(n.value.style.top="-30px",n.value.style["border-radius"]="4px 4px 0px 0px",p.value="top"))}function L(){var Z,J,ie,re;var l,u;const s=h.value;if(!s)return;const{top:_,left:g}=(Z=t==null?void 0:t.getBoundingClientRect())!=null?Z:{top:0,left:0},{top:f,left:x,width:c,height:N}=(J=(l=s.getBoundingClientRect)==null?void 0:l.call(s))!=null?J:(u=s.nextElementSibling)==null?void 0:u.getBoundingClientRect(),$=B.value?1:k.value,H=f-_+((ie=t==null?void 0:t.scrollTop)!=null?ie:0)*$,G=x-g+((re=t==null?void 0:t.scrollLeft)!=null?re:0)*$;r.value&&(r.value.style.width=`${c/$}px`,r.value.style.height=`${N/$}px`,r.value.style.top=`${H/$}px`,r.value.style.left=`${G/$}px`)}function P(l){const u=window.MutationObserver,s={childList:!0,attributes:!0,subtree:!0};return{mutationObserver:new u(l),observerConfig:s}}function ye(){var N;var l,u;const s=ve(v.schemas,(N=(l=e.state.checkedNode)==null?void 0:l.id)!=null?N:"root");if(!s)return!1;const{list:_,schema:g,index:f}=s,x=Me({...g,id:pe()});_.splice(f+1,0,x);const c=x.children?[...x.children]:[];for(;c.length>0;){const $=c.pop();$.id=pe(),((u=$.children)==null?void 0:u.length)>0&&c.push(...$.children)}e.setCheckedNode(x),X.push(v.schemas,"\u590D\u5236\u7EC4\u4EF6")}function we(){var f;var l;const u=ve(v.schemas,(f=(l=e.state.checkedNode)==null?void 0:l.id)!=null?f:"root");if(!u)return!1;let{list:s,schema:_,index:g}=u;s.splice(g,1),g===s.length&&g--,e.setCheckedNode(s[g]),X.push(v.schemas,"\u5220\u9664\u7EC4\u4EF6")}return be(()=>{t=document.querySelector(".epic-edit-range"),t==null||t.addEventListener("scroll",()=>{F()}),ne(o,F),ne(h,F)}),(l,u)=>{var c;var s,_,g,f,x;return V(),O(ge,null,[le(y("div",{ref_key:"selectorRef",ref:i,class:ae(["checked-widget absolute pointer-events-none z-20",p.value+" "+(b.value?"transition-all":"")])},[y("div",{class:"action-box",ref_key:"actionBoxRef",ref:n},[y("div",je,ke((_=a(q).getComponentConfingByType((c=(s=a(e).state.checkedNode)==null?void 0:s.type)!=null?c:""))==null?void 0:_.defaultSchema.label),1),y("div",{title:"\u590D\u5236",class:"action-item pointer-events-auto",onClick:ye},[T(a(he),{name:"icon-fuzhi3"})]),y("div",{title:"\u5220\u9664",class:"action-item pointer-events-auto",onClick:we},[T(a(he),{name:"icon-shanchu1"})])],512)],2),[[oe,w.value&&((g=a(e).state.checkedNode)==null?void 0:g.id)!=="root"]]),le(y("div",{ref_key:"hoverWidgetRef",ref:r,class:"hover-widget absolute transition-all pointer-events-none z-998"},null,512),[[oe,C.value&&((f=a(e).state.checkedNode)==null?void 0:f.id)!==((x=a(e).state.hoverNode)==null?void 0:x.id)]])],64)}}}),Oe=["index","onClick","onMouseover"],me=A({name:"EditNodeItem",__name:"editNodeItem",props:{schemas:{}},emits:["update:schemas"],setup(M,{emit:d}){const v=M,e=j("designer"),i=j("pageSchema"),r=z({get(){return v.schemas},set(b){d("update:schemas",b)}});function n(b){e.setCheckedNode(r.value[b]),e.setDisableHover(!0)}function w(){e.setDisableHover(),X.push(i.schemas,"\u62D6\u62FD\u7EC4\u4EF6")}function C(){X.push(i.schemas,"\u63D2\u5165\u7EC4\u4EF6")}return(b,p)=>(V(),Q(a(Fe),Re({modelValue:r.value,"onUpdate:modelValue":p[1]||(p[1]=k=>r.value=k),"item-key":"id","component-data":{type:"transition-group"},class:"draggable-range"},{animation:200,group:"edit-draggable",ghostClass:"moveing"},{onStart:p[2]||(p[2]=k=>n(k.oldIndex)),onEnd:p[3]||(p[3]=k=>w()),onAdd:p[4]||(p[4]=k=>{n(k.newIndex),C()})}),{item:W(({element:k,index:B})=>[y("div",{class:"widget-box",index:B,onClick:ee(t=>a(e).setCheckedNode(k),["stop"]),onMouseover:ee(t=>a(e).setHoverNode(k),["stop"]),onMouseout:p[0]||(p[0]=ee(t=>a(e).setHoverNode(null),["stop"]))},[T(xe,{schema:k},null,8,["schema"])],40,Oe)]),_:1},16,["modelValue"]))}}),xe=A({name:"ENodeItem",__name:"nodeItem",props:{schema:{},name:{}},setup(M){const d=M,v=Ce();Ne("nodeAttrs",v);function e(){var i;return(i=d.schema.slots)!=null?i:{}}return(i,r)=>{var n;const w=Se("ENodeItem");return["row","tabs"].includes((n=d.schema)==null?void 0:n.type)?(V(),Q(a(de),{key:0,record:d.schema},{"edit-node":W(()=>[(V(!0),O(ge,null,ue(d.schema.children,C=>(V(),Q(w,{key:C.id,schema:C},null,8,["schema"]))),128))]),_:1},8,["record"])):(V(),Q(a(de),{key:1,record:d.schema},_e({"edit-node":W(()=>[d.schema.children?(V(),Q(me,{key:0,schemas:d.schema.children,"onUpdate:schemas":r[0]||(r[0]=C=>d.schema.children=C)},null,8,["schemas"])):fe("",!0)]),_:2},[ue(e(),(C,b)=>({name:`edit-${b}`,fn:W(()=>[T(me,{class:"slot-draggable-range",schemas:e()[b],"onUpdate:schemas":p=>e()[b]=p},null,8,["schemas","onUpdate:schemas"])])}))]),1032,["record"]))}}}),Ae={class:"edit-toolbar flex items-center justify-end text-gray-500 px-4 mx-1"},Le=y("span",{class:"icon iconfont"},"\uE60B",-1),Pe=[Le],Ze=y("span",{class:"icon iconfont"},"\uE60C",-1),Je={key:0,class:"flex items-center"},Qe={class:"pr-8px w-82px cursor-pointer"},We={class:"w-90px cursor-pointer"},qe=A({__name:"toolbar",setup(M){const d=q.getComponent("slider"),v=q.getComponent("select"),{canvasScale:e,disabledZoom:i}=se(),r=j("pageSchema"),n=E(null),w=z({get(){return`${(e.value*100).toFixed(0)}%`},set(t){e.value=Number(t)}}),C=[{label:"60%",value:"0.6"},{label:"80%",value:"0.8"},{label:"100%",value:"1.0"},{label:"120%",value:"1.2"},{label:"140%",value:"1.4"}];function b(t="demo.json"){let o="data:text/json;charset=utf-8,";o+=JSON.stringify(r,null,2);var h=encodeURI(o),R=document.createElement("a");R.setAttribute("href",h),R.setAttribute("download",t),R.click()}function p(){var t;(t=n.value)==null||t.click()}function k(t){var o;const h=(o=t.target.files)==null?void 0:o[0];if(!h)return;t.target.value=null;const R=new FileReader;R.readAsText(h),R.onload=D=>{var U;B((U=D.target)==null?void 0:U.result)}}function B(t){try{const o=JSON.parse(t!=null?t:"");Ue(r,o)}catch(o){console.error(o)}}return(t,o)=>(V(),O("div",Ae,[y("div",{title:"\u5BFC\u51FA",class:"pr-16px cursor-pointer",onClick:o[0]||(o[0]=h=>b("demo.json"))},Pe),y("div",{title:"\u5BFC\u5165",class:"pr-16px cursor-pointer",onClick:o[1]||(o[1]=h=>p())},[Ze,le(y("input",{type:"file",ref_key:"fileRef",ref:n,onChange:k},null,544),[[oe,!1]])]),a(i)?fe("",!0):(V(),O("div",Je,[y("div",Qe,[T(a(v),{value:w.value,"onUpdate:value":o[2]||(o[2]=h=>w.value=h),modelValue:w.value,"onUpdate:modelValue":o[3]||(o[3]=h=>w.value=h),options:C,size:"small"},null,8,["value","modelValue"])]),y("div",We,[T(a(d),{min:.6,max:1.4,step:.01,tooltip:!1,value:a(e),"onUpdate:value":o[4]||(o[4]=h=>ce(e)?e.value=h:null),modelValue:a(e),"onUpdate:modelValue":o[5]||(o[5]=h=>ce(e)?e.value=h:null)},null,8,["value","modelValue"])])]))]))}}),He={class:"h-full flex flex-col relative"},Ge=["draggable"],Ke=A({__name:"editScreenContainer",props:{rootSchema:{}},setup(M){const d=M,v=E(null),e=E(null),{pressSpace:i,disabledZoom:r}=se(),{handleElementDragStart:n,handleElementDrag:w,handleElementDragEnd:C}=Ee(v),{width:b,height:p}=Ve(v),{canvasScale:k,handleZoom:B}=Te(e);let t=0,o=0;const h=E({}),R=E({}),D=z(()=>{var L,P;var S,m;const I=parseFloat((L=(S=d.rootSchema.componentProps.style)==null?void 0:S.width)!=null?L:0),F=parseFloat((P=(m=d.rootSchema.componentProps.style)==null?void 0:m.height)!=null?P:0);return{width:I,height:F}});Be(b,U),K(()=>d.rootSchema.componentProps.style.width,U);function U(){if(r.value){R.value={width:t+"px",height:o+"px",transform:"translate(0px, 20px)"};return}let S=D.value.width||t,m=D.value.height||o;h.value={width:b.value+S+"px",height:p.value+m+"px"},R.value={width:S+"px",height:m+"px"},Y()}function Y(){$e(()=>{let S=D.value.width||t;const m=(D.value.height||o)/2,I=S/2;v.value.scrollTo(I,m)})}return ne(v,([{contentRect:S}])=>{if(t=S.width-60,o=S.height-80,!r.value){const m=(S.width-20)/D.value.width;m<1.2&&(k.value=m)}U()}),(S,m)=>(V(),O("div",He,[T(qe),y("div",{ref_key:"editScreenContainerRef",ref:v,class:ae(["flex-1 overflow-auto overflow-y-hidden epic-edit-screen-container",{"cursor-grab":a(i)}]),draggable:a(i),onWheel:m[0]||(m[0]=(...I)=>a(B)&&a(B)(...I)),onDragstart:m[1]||(m[1]=(...I)=>a(n)&&a(n)(...I)),onDragend:m[2]||(m[2]=(...I)=>a(C)&&a(C)(...I)),onDrag:m[3]||(m[3]=(...I)=>a(w)&&a(w)(...I))},[y("div",{id:"canvasContainer",class:"flex items-center justify-center",style:te(h.value)},[y("div",{ref_key:"draggableElRef",ref:e,class:"transition-all"},[y("div",{class:ae({"pointer-events-none":a(i)}),style:te(R.value)},[Ie(S.$slots,"default")],6)],512)],4)],42,Ge)]))}}),Xe={class:"epic-edit-canvas"},at=A({__name:"index",setup(M){const d=j("pageSchema"),v=z(()=>d.schemas[0]),e=z(()=>{var n,w;var i,r;return{width:(n=(i=v.value.componentProps.style)==null?void 0:i.width)!=null?n:"100%",height:(w=(r=v.value.componentProps.style)==null?void 0:r.height)!=null?w:"100%"}});return(i,r)=>(V(),O("section",Xe,[T(Ke,{"root-schema":v.value},{default:W(()=>[y("div",{class:"epic-edit-range rounded-md overflow-auto relative",style:te(e.value)},[T(xe,{schema:v.value},null,8,["schema"]),T(ze)],4)]),_:1},8,["root-schema"])]))}});export{at as default};
