import{e as U,j,f as P,o as R,c as z,d as M,q as G,b,s as te,r as I,w as Y,k as ye,D as le,E as oe,u as a,P as be,n as ae,M as he,U as we,p as ke,V as Ce,v as Z,Y as Ne,F as me,N as Se,g as _e,A as ee,m as $e,a4 as ue}from"../app.27d58f12.js";import{s as se,F as J,h as ne,P as de,B as Be,j as Ie,k as Re,M as Ee,a as De,b as ce,o as Ve,L as ve,z as K,l as Me}from"./index-980e4b1c.94133bb0.js";import{p as pe}from"./icon.vue_vue_type_script_setup_true_lang-cc078b52.f6aad2d9.js";import{R as Fe}from"./vuedraggable.umd-6a5b6da9.37fa0675.js";import"./commonjsHelpers-c5d32002.490f5bf3.js";const Te={class:"action-item whitespace-nowrap"},Ae=U({__name:"previewWidgets",setup(F){const f=j("pageManager",{}),c=j("pageSchema"),t=j("designer"),d=I(null),s=I(null),i=I(null),v=I(!1),E=I(!1),$=I(!0),x=I("top"),{canvasScale:w,disabledZoom:D}=se();let e=null;const o=P(()=>{var S;var l,r,n,N,m;const g=f.componentInstances.value,y=(l=t.state.checkedNode)==null?void 0:l.id,u=(S=J.getComponentConfingByType((r=t.state.checkedNode)==null?void 0:r.type))!=null?S:null;if(!y||!(g!=null&&g[y]))return null;if(u!=null&&u.defaultSchema.input&&((n=t.state.checkedNode)==null?void 0:n.noFormItem)!==!0)return(N=g[y+"formItem"])==null?void 0:N.$el;const k=g[y];return((m=k==null?void 0:k.$el)==null?void 0:m.nodeName)==="#text"?null:k==null?void 0:k.$el}),p=P(()=>{var k;var l,r,n,N;const m=f.componentInstances.value,g=(l=t.state.hoverNode)==null?void 0:l.id,y=(k=J.getComponentConfingByType((r=t.state.hoverNode)==null?void 0:r.type))!=null?k:null;if(!g||!(m!=null&&m[g]))return null;if(y!=null&&y.defaultSchema.input&&((n=t.state.hoverNode)==null?void 0:n.noFormItem)!==!0)return(N=m[g+"formItem"])==null?void 0:N.$el;const u=m[g];return(u==null?void 0:u.$el.nodeName)==="#text"?null:u==null?void 0:u.$el}),{mutationObserver:B,observerConfig:V}=L(A),{startTimedQuery:T,stopTimedQuery:X}=De(A);Y(()=>o.value,l=>{if(l){v.value=!0,B.observe(l,V);const r=l.parentNode;r&&(r.ondragstart=()=>{$.value=!1,T()},r.ondragend=()=>{$.value=!0,X()}),A()}else v.value=!1});const{mutationObserver:C,observerConfig:h}=L(H);Y(()=>p.value,l=>{l&&(C.observe(l,h),H())});let _=0;Y(()=>{var l;return(l=t.state.hoverNode)==null?void 0:l.id},l=>{E.value=!0,clearTimeout(_),!l&&(_=setTimeout(()=>{E.value=!1},300))});function A(){var q,O,Q;const l=o.value;if(!l)return;const{top:r,left:n}=(q=e==null?void 0:e.getBoundingClientRect())!=null?q:{top:0,left:0},{top:N,left:m,width:g,height:y}=l.getBoundingClientRect(),u=D.value?1:w.value,k=N-r+((O=e==null?void 0:e.scrollTop)!=null?O:0)*u,S=m-n+((Q=e==null?void 0:e.scrollLeft)!=null?Q:0)*u,W=y/u;d.value&&(d.value.style.width=`${g/u}px`,d.value.style.height=`${W}px`,d.value.style.top=`${k/u}px`,d.value.style.left=`${S/u}px`),i.value&&(k<45&&W<100?(i.value.style.top="",i.value.style.bottom="-30px",i.value.style["border-radius"]="0px 0px 4px 4px",x.value="bottom"):k<45?(i.value.style.top="0px",i.value.style["border-radius"]="0px 0px 4px 0",x.value="center"):(i.value.style.top="-30px",i.value.style["border-radius"]="4px 4px 0px 0px",x.value="top"))}function H(){var O,Q,ie,re;var l,r;const n=p.value;if(!n)return;const{top:N,left:m}=(O=e==null?void 0:e.getBoundingClientRect())!=null?O:{top:0,left:0},{top:g,left:y,width:u,height:k}=(Q=(l=n.getBoundingClientRect)==null?void 0:l.call(n))!=null?Q:(r=n.nextElementSibling)==null?void 0:r.getBoundingClientRect(),S=D.value?1:w.value,W=g-N+((ie=e==null?void 0:e.scrollTop)!=null?ie:0)*S,q=y-m+((re=e==null?void 0:e.scrollLeft)!=null?re:0)*S;s.value&&(s.value.style.width=`${u/S}px`,s.value.style.height=`${k/S}px`,s.value.style.top=`${W/S}px`,s.value.style.left=`${q/S}px`)}function L(l){const r=window.MutationObserver,n={childList:!0,attributes:!0,subtree:!0};return{mutationObserver:new r(l),observerConfig:n}}function fe(){var k;var l,r;const n=ce(c.schemas,(k=(l=t.state.checkedNode)==null?void 0:l.id)!=null?k:"root");if(!n)return!1;const{list:N,schema:m,index:g}=n,y=Ve({...m,id:ve()});N.splice(g+1,0,y);const u=y.children?[...y.children]:[];for(;u.length>0;){const S=u.pop();S.id=ve(),((r=S.children)==null?void 0:r.length)>0&&u.push(...S.children)}t.setCheckedNode(y),K.push(c.schemas,"\u590D\u5236\u7EC4\u4EF6")}function xe(){var g;var l;const r=ce(c.schemas,(g=(l=t.state.checkedNode)==null?void 0:l.id)!=null?g:"root");if(!r)return!1;let{list:n,schema:N,index:m}=r;n.splice(m,1),m===n.length&&m--,t.setCheckedNode(n[m]),K.push(c.schemas,"\u5220\u9664\u7EC4\u4EF6")}return ye(()=>{e=document.querySelector(".epic-edit-range"),e==null||e.addEventListener("scroll",()=>{A()}),ne(o,A),ne(p,A)}),(l,r)=>{var u;var n,N,m,g,y;return R(),z(he,null,[le(b("div",{ref_key:"selectorRef",ref:d,class:ae(["checked-widget absolute pointer-events-none z-20",x.value+" "+($.value?"transition-all":"")])},[b("div",{class:"action-box",ref_key:"actionBoxRef",ref:i},[b("div",Te,be((N=a(J).getComponentConfingByType((u=(n=a(t).state.checkedNode)==null?void 0:n.type)!=null?u:""))==null?void 0:N.defaultSchema.label),1),b("div",{title:"\u590D\u5236",class:"action-item pointer-events-auto",onClick:fe},[M(a(pe),{name:"icon-fuzhi3"})]),b("div",{title:"\u5220\u9664",class:"action-item pointer-events-auto",onClick:xe},[M(a(pe),{name:"icon-shanchu1"})])],512)],2),[[oe,v.value&&((m=a(t).state.checkedNode)==null?void 0:m.id)!=="root"]]),le(b("div",{ref_key:"hoverWidgetRef",ref:s,class:"hover-widget absolute transition-all pointer-events-none z-998"},null,512),[[oe,E.value&&((g=a(t).state.checkedNode)==null?void 0:g.id)!==((y=a(t).state.hoverNode)==null?void 0:y.id)]])],64)}}}),je=["index","onClick","onMouseover"],Pe=U({name:"EditNodeItem",__name:"editNodeItem",props:{schemas:{}},emits:["update:schemas"],setup(F,{emit:f}){const c=F,t=j("designer"),d=j("pageSchema"),s=P({get(){return c.schemas},set($){f("update:schemas",$)}});function i($){t.setCheckedNode(s.value[$])}function v(){t.setDisableHover(),K.push(d.schemas,"\u62D6\u62FD\u7EC4\u4EF6")}function E(){K.push(d.schemas,"\u63D2\u5165\u7EC4\u4EF6")}return($,x)=>(R(),Z(a(Fe),$e({modelValue:s.value,"onUpdate:modelValue":x[1]||(x[1]=w=>s.value=w),"item-key":"id","component-data":{name:"draggable-range",type:"transition-group"},class:"draggable-range"},{animation:200,group:"edit-draggable",ghostClass:"moveing"},{onStart:x[2]||(x[2]=w=>{i(w.oldIndex),a(t).setDisableHover(!0)}),onEnd:x[3]||(x[3]=w=>v()),onAdd:x[4]||(x[4]=w=>{i(w.newIndex),E()})}),{item:G(({element:w,index:D})=>[b("div",{class:"widget-box",index:D,onClick:ee(e=>a(t).setCheckedNode(w),["stop"]),onMouseover:ee(e=>a(t).setHoverNode(w),["stop"]),onMouseout:x[0]||(x[0]=ee(e=>a(t).setHoverNode(null),["stop"]))},[M(ge,{schema:w},null,8,["schema"])],40,je)]),_:1},16,["modelValue"]))}}),ge=U({name:"ENodeItem",__name:"nodeItem",props:{schema:{},name:{}},setup(F){const f=F,c=we();return ke("nodeAttrs",c),(t,d)=>{var s;const i=Ce("ENodeItem");return["row","tabs"].includes((s=f.schema)==null?void 0:s.type)?(R(),Z(a(de),{key:0,record:f.schema},{"edit-node":G(()=>[(R(!0),z(he,null,Ne(f.schema.children,v=>(R(),Z(i,{key:v.id,schema:v},null,8,["schema"]))),128))]),_:1},8,["record"])):(R(),Z(a(de),{key:1,record:f.schema},{"edit-node":G(()=>[f.schema.children?(R(),Z(Pe,{key:0,schemas:f.schema.children,"onUpdate:schemas":d[0]||(d[0]=v=>f.schema.children=v)},null,8,["schemas"])):me("",!0)]),_:1},8,["record"]))}}}),ze={class:"edit-toolbar flex items-center justify-end text-gray-500 px-4 mx-1"},Ue=b("span",{class:"icon iconfont"},"\uE60B",-1),He=[Ue],Le=b("span",{class:"icon iconfont"},"\uE60C",-1),Oe={key:0,class:"flex items-center"},Qe={class:"pr-8px w-82px cursor-pointer"},Ze={class:"w-90px cursor-pointer"},Je=U({__name:"toolbar",setup(F){const f=J.getComponent("slider"),c=J.getComponent("select"),{canvasScale:t,disabledZoom:d}=se(),s=j("pageSchema"),i=I(null),v=P({get(){return`${(t.value*100).toFixed(0)}%`},set(e){t.value=Number(e)}}),E=[{label:"60%",value:"0.6"},{label:"80%",value:"0.8"},{label:"100%",value:"1.0"},{label:"120%",value:"1.2"},{label:"140%",value:"1.4"}];function $(e="demo.json"){let o="data:text/json;charset=utf-8,";o+=JSON.stringify(s,null,2);var p=encodeURI(o),B=document.createElement("a");B.setAttribute("href",p),B.setAttribute("download",e),B.click()}function x(){var e;(e=i.value)==null||e.click()}function w(e){var o;const p=(o=e.target.files)==null?void 0:o[0];if(!p)return;e.target.value=null;const B=new FileReader;B.readAsText(p),B.onload=V=>{var T;D((T=V.target)==null?void 0:T.result)}}function D(e){try{const o=JSON.parse(e!=null?e:"");Me(s,o)}catch(o){console.error(o)}}return(e,o)=>(R(),z("div",ze,[b("div",{title:"\u5BFC\u51FA",class:"pr-16px cursor-pointer",onClick:o[0]||(o[0]=p=>$("demo.json"))},He),b("div",{title:"\u5BFC\u5165",class:"pr-16px cursor-pointer",onClick:o[1]||(o[1]=p=>x())},[Le,le(b("input",{type:"file",ref_key:"fileRef",ref:i,onChange:w},null,544),[[oe,!1]])]),a(d)?me("",!0):(R(),z("div",Oe,[b("div",Qe,[M(a(c),{value:v.value,"onUpdate:value":o[2]||(o[2]=p=>v.value=p),modelValue:v.value,"onUpdate:modelValue":o[3]||(o[3]=p=>v.value=p),options:E,size:"small"},null,8,["value","modelValue"])]),b("div",Ze,[M(a(f),{min:.6,max:1.4,step:.01,tooltip:!1,value:a(t),"onUpdate:value":o[4]||(o[4]=p=>ue(t)?t.value=p:null),modelValue:a(t),"onUpdate:modelValue":o[5]||(o[5]=p=>ue(t)?t.value=p:null)},null,8,["value","modelValue"])])]))]))}}),We={class:"h-full flex flex-col relative"},qe=["draggable"],Ye=U({__name:"editScreenContainer",props:{rootSchema:{}},setup(F){const f=F,c=I(null),t=I(null),{pressSpace:d,disabledZoom:s}=se(),{handleElementDragStart:i,handleElementDrag:v,handleElementDragEnd:E}=Be(c),{width:$,height:x}=Ie(c),{canvasScale:w,handleZoom:D}=Re(t);let e=0,o=0;const p=I({}),B=I({}),V=P(()=>{var H,L;var C,h;const _=parseFloat((H=(C=f.rootSchema.componentProps.style)==null?void 0:C.width)!=null?H:0),A=parseFloat((L=(h=f.rootSchema.componentProps.style)==null?void 0:h.height)!=null?L:0);return{width:_,height:A}});Ee($,T),Y(()=>f.rootSchema.componentProps.style.width,T);function T(){if(s.value){B.value={width:e+"px",height:o+"px",transform:"translate(0px, 20px)"};return}let C=V.value.width||e,h=V.value.height||o;p.value={width:$.value+C+"px",height:x.value+h+"px"},B.value={width:C+"px",height:h+"px"},X()}function X(){Se(()=>{let C=V.value.width||e;const h=(V.value.height||o)/2,_=C/2;c.value.scrollTo(_,h)})}return ne(c,([{contentRect:C}])=>{if(e=C.width-60,o=C.height-80,!s.value){const h=(C.width-20)/V.value.width;h<1.2&&(w.value=h)}T()}),(C,h)=>(R(),z("div",We,[M(Je),b("div",{ref_key:"editScreenContainerRef",ref:c,class:ae(["flex-1 overflow-auto overflow-y-hidden epic-edit-screen-container",{"cursor-grab":a(d)}]),draggable:a(d),onWheel:h[0]||(h[0]=(..._)=>a(D)&&a(D)(..._)),onDragstart:h[1]||(h[1]=(..._)=>a(i)&&a(i)(..._)),onDragend:h[2]||(h[2]=(..._)=>a(E)&&a(E)(..._)),onDrag:h[3]||(h[3]=(..._)=>a(v)&&a(v)(..._))},[b("div",{id:"canvasContainer",class:"flex items-center justify-center",style:te(p.value)},[b("div",{ref_key:"draggableElRef",ref:t,class:"transition-all"},[b("div",{class:ae({"pointer-events-none":a(d)}),style:te(B.value)},[_e(C.$slots,"default")],6)],512)],4)],42,qe)]))}}),Ge={class:"epic-edit-canvas"},ot=U({__name:"index",setup(F){const f=j("pageSchema"),c=P(()=>f.schemas[0]),t=P(()=>{var i,v;var d,s;return{width:(i=(d=c.value.componentProps.style)==null?void 0:d.width)!=null?i:"100%",height:(v=(s=c.value.componentProps.style)==null?void 0:s.height)!=null?v:"100%"}});return(d,s)=>(R(),z("section",Ge,[M(Ye,{"root-schema":c.value},{default:G(()=>[b("div",{class:"epic-edit-range rounded-md overflow-auto relative",style:te(t.value)},[M(ge,{schema:c.value},null,8,["schema"]),M(Ae)],4)]),_:1},8,["root-schema"])]))}});export{ot as default};
